---
title: Image State API
---

## Overview

The editor persists the *working* image transform per project using **µpx fixed-point integers** so the canvas can be restored without drift.

Save triggers (important):

- Saves happen **only** on explicit user actions (e.g. drag end / transform end / apply).
- Unit dropdown changes are **display-only** and must **not** trigger any save (including debounced saves).

Endpoint:

- `GET /api/projects/:projectId/image-state`
- `POST /api/projects/:projectId/image-state`

Auth:

- Requires an authenticated Supabase user (cookie-based auth via SSR client).
- Project access is enforced via RLS and an explicit "project accessible" check.

## Data model (DB)

Table: `public.project_image_state`

Key:

- `(project_id, role)` where `role` is `master` or `working`

Fields:

- **canonical µpx size**: `width_px_u`, `height_px_u` (string BigInt, required)
- **optional µpx position**: `x_px_u`, `y_px_u` (string BigInt)
- **rotation**: `rotation_deg` (number)

## GET response

```json
{
  "exists": true,
  "state": {
    "project_id": "uuid",
    "role": "master",
    "x_px_u": "123450000",
    "y_px_u": "67890000",
    "width_px_u": "1024500000",
    "height_px_u": "768250000",
    "rotation_deg": 0,
  }
}
```

If no state exists:

```json
{ "exists": false, "state": null }
```

## POST payload

```json
{
  "role": "master",
  "x_px_u": "123450000",
  "y_px_u": "67890000",
  "width_px_u": "1024500000",
  "height_px_u": "768250000",
  "rotation_deg": 0,
}
```

Notes:

- `width_px_u/height_px_u` are required when `exists=true`.
- No runtime fallback/migration is supported. If `width_px_u/height_px_u` are missing, the state is considered unsupported.

